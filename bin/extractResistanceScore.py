#!/usr/bin/env python3

import json
import csv
import argparse

def json2csv(infile, outfile, sample_name, write_header=True):
    results = json.load(infile)
    writer = csv.writer(outfile)

    first_row = True
    for result in results:
        if first_row and write_header:
            # use this row to generate labels
            drugs = []
            for d in result['drugResistance']:
                for d2 in d['drugScores']:
                    drugs.append(d2['drug']['name'])

            writer.writerow(['Sample', 'Subtype'] + drugs)
            first_row = False

        scores = []
        for d in result['drugResistance']:
            for d2 in d['drugScores']:
                scores.append(d2['score'])

        writer.writerow(
            [sample_name, result['subtypeText']] + scores
        )

if __name__ == '__main__':
    parser = argparse.ArgumentParser(
        description="Convert JSON generated by running a Sierra processor "
                    "into a more accessible CSV format, retaining only "
                    "drug-specific resistance scores.")

    parser.add_argument('--json', required=True, help='Input Sierra JSON results file', type=argparse.FileType('r'))
    parser.add_argument('--csv', required=True, help='Output CSV file', type=argparse.FileType('w'))
    parser.add_argument('--sample', required=True, help='Sample name to use in CSV', type=str)

    args = parser.parse_args()

    json2csv(infile=args.json, outfile=args.csv, sample_name=args.sample)

